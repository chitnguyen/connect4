{% extends 'base.html' %}
{% block content %}
    {% if request.user.is_authenticated %}
        <p class="bs-component">
            <center>
                <p>Welcome <b>{{ request.user.username }}</b></p>
                <input class="btn btn-success btn-sm" onclick="location.href = '/connect4/logout/';"type="submit" value="Log Out" />
                <input class="btn btn-success btn-sm" onclick="location.href = '/connect4/games/';"type="submit" value="Back to Games" />
            </center>
        </p>
    {% else %}
        <p class="bs-component">
            <center>
                <p>Please login to see this page.</p>
                <input class="btn btn-success btn-sm" onclick="location.href = '/connect4/login/';"type="submit" value="Log In" />
            </center>
        </p>
    {% endif %}
    <p>You are in game #{{ game.id }}</p>
    <p>Players: {{ game.player1.username }} vs. {{ game.player2.username }}</p>
    <p>Game status: {{ game.status }}</p>
    <p>Winner: {{ game.winner }}</p>
    <input type="hidden" id="status" name="status" value="{{ game.status }}">

    {% for coin in coin_set.all %}
        <p>{{ coin.player.username }}, row: {{ coin.row }}, col: {{ coin.column }}</p>
    {% endfor %}

    <form action="." method="post">
        {% csrf_token %}
        <label for="column">Col: </label>
        <input id="column" type="text" name="column">
        <input type="submit" value="Set Coin" id="setCoin">
    </form>

    <table id="board">
        <tr>
            <td><button class="btn" id="btn00" data-col="0" data-row="0"></button></td>
            <td><button class="btn" id="btn01" data-col="1" data-row="0"></button></td>
            <td><button class="btn" id="btn02" data-col="2" data-row="0"></button></td>
            <td><button class="btn" id="btn03" data-col="3" data-row="0"></button></td>
            <td><button class="btn" id="btn04" data-col="4" data-row="0"></button></td>
            <td><button class="btn" id="btn05" data-col="5" data-row="0"></button></td>
            <td><button class="btn" id="btn06" data-col="6" data-row="0"></button></td>
        </tr>
        <tr>
            <td><button class="btn" id="btn10" data-col="0" data-row="1"></button></td>
            <td><button class="btn" id="btn11" data-col="1" data-row="1"></button></td>
            <td><button class="btn" id="btn12" data-col="2" data-row="1"></button></td>
            <td><button class="btn" id="btn13" data-col="3" data-row="1"></button></td>
            <td><button class="btn" id="btn14" data-col="4" data-row="1"></button></td>
            <td><button class="btn" id="btn15" data-col="5" data-row="1"></button></td>
            <td><button class="btn" id="btn16" data-col="6" data-row="1"></button></td>
        </tr>
        <tr>
            <td><button class="btn" id="btn20" data-col="0" data-row="2"></button></td>
            <td><button class="btn" id="btn21" data-col="1" data-row="2"></button></td>
            <td><button class="btn" id="btn22" data-col="2" data-row="2"></button></td>
            <td><button class="btn" id="btn23" data-col="3" data-row="2"></button></td>
            <td><button class="btn" id="btn24" data-col="4" data-row="2"></button></td>
            <td><button class="btn" id="btn25" data-col="5" data-row="2"></button></td>
            <td><button class="btn" id="btn26" data-col="6" data-row="2"></button></td>
        </tr>
        <tr>
            <td><button class="btn" id="btn30" data-col="0" data-row="3"></button></td>
            <td><button class="btn" id="btn31" data-col="1" data-row="3"></button></td>
            <td><button class="btn" id="btn32" data-col="2" data-row="3"></button></td>
            <td><button class="btn" id="btn33" data-col="3" data-row="3"></button></td>
            <td><button class="btn" id="btn34" data-col="4" data-row="3"></button></td>
            <td><button class="btn" id="btn35" data-col="5" data-row="3"></button></td>
            <td><button class="btn" id="btn36" data-col="6" data-row="3"></button></td>
        </tr>
        <tr>
            <td><button class="btn" id="btn40" data-col="0" data-row="4"></button></td>
            <td><button class="btn" id="btn41" data-col="1" data-row="4"></button></td>
            <td><button class="btn" id="btn42" data-col="2" data-row="4"></button></td>
            <td><button class="btn" id="btn43" data-col="3" data-row="4"></button></td>
            <td><button class="btn" id="btn44" data-col="4" data-row="4"></button></td>
            <td><button class="btn" id="btn45" data-col="5" data-row="4"></button></td>
            <td><button class="btn" id="btn46" data-col="6" data-row="4"></button></td>
        </tr>
        <tr>
            <td><button class="btn" id="btn50" data-col="0" data-row="5"></button></td>
            <td><button class="btn" id="btn51" data-col="1" data-row="5"></button></td>
            <td><button class="btn" id="btn52" data-col="2" data-row="5"></button></td>
            <td><button class="btn" id="btn53" data-col="3" data-row="5"></button></td>
            <td><button class="btn" id="btn54" data-col="4" data-row="5"></button></td>
            <td><button class="btn" id="btn55" data-col="5" data-row="5"></button></td>
            <td><button class="btn" id="btn56" data-col="6" data-row="5"></button></td>
        </tr>
    </table>

    <div id="result"></div>


    <script type="text/javascript">
{#        $(document).ready(function () {#}
{##}
{##}
{#            $("#board tr td button").on("click", function (e) {#}
{#                e.preventDefault();#}
{#                var col = $(this).data("col");#}
{#                var row = $(this).data("row");#}
{#                $("#result").text("Row: " + row + ", Col: " + col);#}
{#                var id = "btn"+row+col;#}
{#                var button = document.getElementById(id);#}
{#                button.style.cssText += 'background-color: ' + colour#}
{#            });#}
{#        });#}
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            var players = {{ player_turns }};
            var rows = {{ rows }};
            var cols = {{ cols }};
            var status = $("#status").val();
            var current_player = {{ request.user.id }};
            var first_player = {{ game.player1.id }};
            var colour = (current_player == first_player)? 'red' : 'yellow';
            {% if last_move %}
                var last_move_row = {{ last_move.row }};
                var last_move_col = {{ last_move.column }};
                var id = "btn" + last_move_row + last_move_col;
                var last_move = document.getElementById(id);
                last_move.style.cssText += 'border: 5px solid #2c3e50';
            {% endif %}
            prepareField();
            updateCurrentField(players, rows, cols, first_player);

            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            $.ajaxSetup({
                headers: { "X-CSRFToken": getCookie("csrftoken") }
            });

            $("#board tr td button").click(function(e) {
                    e.preventDefault();
                    if (status!='Concluded'){
                        var col = $(this).data("col");
                        //var row = $(this).data("row");
                        //var column = Number($("#column").val());
                        var row = firstFreeRow(col);
                        $("#result").text("Row: " + row + ", Col: " + col);

                        //alert(row);
                        if (row == -1) {
                            alert('You cannot put more coin in this column!');
                        } else {
                            var id = "btn"+row+col;
                            var button = document.getElementById(id);
{#                            button.style.cssText += 'background-color: ' + colour#}
                            if (checkForVictory(current_player, row, col)) {
                                alert('You win!');
                                status = "Concluded";
                            }
                            //alert('Posting coin move to server!');
                            $.post("/connect4/play/{{ game.id }}/", {row: row, column: col, status: status})
                                    .done(function (data) {
                                        window.location.reload(true);
                                    })
                                    .fail(function (xhr, status, error) {
                                        alert(xhr.responseText);
                                    });
                        }
                    } else {
                        alert('Game already finished!');
                    }
                })
        });
    </script>

{% endblock %}


{% block javascript %}


<script>
    {% if not request.user.is_authenticated %}
    $("ul.nav.navbar-nav.navbar-right").css("display","none");
    {% endif %}
</script>

{% endblock %}